<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.0.0"
           xmlns:camel="http://camel.apache.org/schema/blueprint"
           xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
           xsi:schemaLocation="
             http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
             ">


		<!--<cxf:cxfEndpoint id="lifeCxfEndpoint"-->
			<!--address="{{ua.np.services.smsinfo.life.test.address}}/{{ua.np.services.smsinfo.life.test.name}}"-->
			<!--serviceClass="ua.np.services.smsinfo.life.SmsService"-->
			<!--endpointName="e:lifeEndpoint"-->
			<!--serviceName="s:lifeService"-->
			<!--xmlns:e="http://smsinfo.services.np.ua/endpoint"-->
			<!--xmlns:s="http://smsinfo.services.np.ua/service"/> -->


    <camelContext id="life-adapter-context" trace="{{ua.np.services.smsinfo.life.camel-trace}}" xmlns="http://camel.apache.org/schema/blueprint"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://camel.apache.org/schema/blueprint ">

        <dataFormats>
            <jaxb contextPath="ua.np.services.smsinfo" prettyPrint="true" id="apiJaxb"/>
        </dataFormats>

        <!--<route trace="true" id="test-life-request">-->
            <!--<from uri="cxf:bean:lifeCxfEndpoint" />-->
            <!--<log message="From Life-adapter ${body}"/>-->
            <!--<setBody>-->
                 <!--<simple>${body[0]}</simple>-->
             <!--</setBody>-->
            <!--<to uri="direct-vm:life"/>-->
        <!--</route>-->

        <route id="life-status-gateway">
            <from uri="jetty:{{ua.np.services.smsinfo.life.gateway.url}}"/>
            <inOnly uri="direct:fromLifeStatus"/>
            <setBody>
                <constant>
                    &lt;status&gt;accepted&lt;/status&gt;
                </constant>
            </setBody>
        </route>

        <route id="direct-life">
            <from uri="direct-vm:life"/>        
            <marshal ref="apiJaxb"/>
            <!--<setHeader headerName="lifeGroup"><simple>${body}</simple></setHeader>-->
            <setProperty propertyName="lifeGroup">
                <simple>${body}</simple>
            </setProperty>
            <!--<log message="[life-adapter-context]:[direct-life] ${body}"/>-->
            <to uri="xslt:smsGroupToLifeSendRequest.xsl"/>
            <!--<log message="Request to Life ${body}"/>-->
            <to id="toLife" uri="jetty:{{ua.np.services.smsinfo.life.request.uri}}"/>
            <to uri="direct:fromLife"/>
        </route>

        <route id="life-to-service">
            <from uri="direct:fromLife"/>
            <convertBodyTo type="java.lang.String" charset="UTF-8"/>
            <!--<log message="Response from Life: ${body}"/>-->
            <to uri="xslt:sendResponseToSmsServiceSmsList.xsl"/>
            <!--<log message="converted response from Life: ${body}"/>-->
            <unmarshal ref="apiJaxb"/>
            <bean ref="groupComparator"/>
            <to id="jpa" uri="direct-vm:persist-responce"/>
        </route>

        <route id="statusResponse">
            <from uri="direct:fromLifeStatus"/>
            <convertBodyTo type="java.lang.String" charset="UTF-8"/>
            <!--<log message="Status response from Life: ${body}"/>-->
            <to uri="xslt:sendResponseToSmsServiceSmsList.xsl"/>
            <unmarshal ref="apiJaxb"/>
            <to id="statusToJpa" uri="direct-vm:update-state"/>
        </route>
    </camelContext>
    
    <bean id="groupComparator" class="ua.np.services.smsinfo.life.CompareGroupResponceProcessor"/>
</blueprint>